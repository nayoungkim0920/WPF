using System.Diagnostics;
using System.IO;
using System.Runtime.CompilerServices;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;

namespace WpfApp2
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        public MainWindow()
        {
            InitializeComponent();

            // ë¡œë”© íŒ¨ë„ì„ ìˆ¨ê¹€
            LoadingPanel.Visibility = Visibility.Collapsed;

            // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë²„íŠ¼ ë¹„í™œì„±í™”
            GrayScaleButton.IsEnabled = false;
            // ìºë‹ˆì—£ì§€ ë²„íŠ¼ ë¹„í™œì„±í™”
            CannyEdgeButton.IsEnabled = false;
            // ìšœë¡œv5 ë²„íŠ¼ ë¹„í™œì„±í™”
            YoloV5Button.IsEnabled = false;
        }

        private void OpenImage_Click(object sender, RoutedEventArgs e)
        {
            var openFileDialog = new Microsoft.Win32.OpenFileDialog
            {
                Filter = "Image Files|*.jpg;*.jpeg;*.png;*.bmp",
                Title = "ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ"
            };

            if(openFileDialog.ShowDialog() == true )
            {
                try
                {
                    var bitmapImage = new BitmapImage();
                    bitmapImage.BeginInit();
                    bitmapImage.CacheOption = BitmapCacheOption.OnLoad; // ë©”ëª¨ë¦¬ì— ì™„ì „íˆ ë¡œë“œ
                    bitmapImage.UriSource = new Uri(openFileDialog.FileName);
                    bitmapImage.EndInit();
                    bitmapImage.Freeze(); // ìŠ¤ë ˆë“œ ì•ˆì „ì„±ì„ ìœ„í•´ ê³ ì •
                    ImageView.Source = bitmapImage;

                    // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë²„íŠ¼ í™œì„±í™”
                    GrayScaleButton.IsEnabled = true;

                    // ìƒíƒœí‘œì‹œì¤„ì— íŒŒì¼ê²½ë¡œ ì¶œë ¥
                    FilePathTextBlock.Text = openFileDialog.FileName;
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}",
                        "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        private async void GrayScale_Click(object sender, RoutedEventArgs e)
        {
            if (ImageView.Source is BitmapImage bitmapImage)
            {
                try
                {
                    // ì²˜ë¦¬ì¤‘ ë³´ì´ê¸°
                    LoadingPanel.Visibility = Visibility.Visible;

                    WriteableBitmap writeableBitmap = null;
                    int width = 0, height = 0;

                    // UI ìŠ¤ë ˆë“œì—ì„œ WriteableBitmap ìƒì„± ë° í¬ê¸° ê°€ì ¸ì˜¤ê¸°
                    Application.Current.Dispatcher.Invoke(() =>
                    {
                        writeableBitmap = new WriteableBitmap(bitmapImage);
                        width = writeableBitmap.PixelWidth;
                        height = writeableBitmap.PixelHeight;
                    });

                    if (writeableBitmap == null || width == 0 || height == 0)
                        throw new InvalidOperationException("WriteableBitmapì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

                    // ì‹œì‘ ì‹œê°„ ê¸°ë¡
                    var startTime = DateTime.Now;

                    // ë¹„ë™ê¸°ì ìœ¼ë¡œ ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë³€í™˜
                    await Task.Run(() => ConvertToGrayScale(writeableBitmap, width, height, startTime));

                    // UI ìŠ¤ë ˆë“œì—ì„œ WriteableBitmap ì—…ë°ì´íŠ¸
                    Application.Current.Dispatcher.Invoke(() =>
                    {
                        writeableBitmap.Freeze();
                        ImageView.Source = writeableBitmap;
                    });
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"ì´ë¯¸ì§€ë¥¼ ê·¸ë ˆì´ìŠ¤ì¼€ì¼ë¡œ ë³€í™˜í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}",
                        "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error);
                }
                finally
                {
                    // ì²˜ë¦¬ì¤‘ ìˆ¨ê¸°ê¸°
                    LoadingPanel.Visibility = Visibility.Collapsed;

                    // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë²„íŠ¼ ë¹„í™œì„±í™”
                    GrayScaleButton.IsEnabled = false;
                    // ìºë‹ˆì—£ì§€ ë²„íŠ¼ í™œì„±í™”
                    CannyEdgeButton.IsEnabled = true;
                }
            }
            else
            {
                MessageBox.Show("ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void ConvertToGrayScale(WriteableBitmap writeableBitmap, int width, int height, DateTime startTime)
        {
            var pixelData = new byte[width * height * 4];

            // UI ìŠ¤ë ˆë“œì—ì„œ í”½ì…€ ë°ì´í„°ë¥¼ ë³µì‚¬
            Application.Current.Dispatcher.Invoke(() =>
            {
                writeableBitmap.CopyPixels(pixelData, width * 4, 0);
            });            

            Parallel.For(0, height, y =>
            {
                for (int x = 0; x < width; x++)
                {
                    int pixelIndex = (y * width + x) * 4;
                    byte a = pixelData[pixelIndex + 3];
                    byte r = pixelData[pixelIndex + 2];
                    byte g = pixelData[pixelIndex + 1];
                    byte b = pixelData[pixelIndex];

                    byte gray = (byte)(0.3 * r + 0.59 * g + 0.11 * b);

                    pixelData[pixelIndex + 3] = a;    // Alpha
                    pixelData[pixelIndex + 2] = gray; // Red
                    pixelData[pixelIndex + 1] = gray; // Green
                    pixelData[pixelIndex] = gray;     // Blue
                }

                // ì²˜ë¦¬ëœ ì‹œê°„ ê³„ì‚°
                //var elapsedTime = DateTime.Now - startTime;
                //var processedRows = y + 1; // í˜„ì¬ ì²˜ë¦¬ëœ ì¤„
                //var totalRows = height;
                //var processingSpeed = (processedRows / elapsedTime.TotalSeconds).ToString("F2"); // ì´ˆë‹¹ ì²˜ë¦¬ëœ ì¤„ ìˆ˜

                // UI ìŠ¤ë ˆë“œì—ì„œ ìƒíƒœ í‘œì‹œì¤„ì— ì²˜ë¦¬ ì†ë„ ì—…ë°ì´íŠ¸
                //Application.Current.Dispatcher.Invoke(() =>
                //{
                //    ProcessTimeTextBlock.Text = $"ì²˜ë¦¬ ì¤‘: {processedRows}/{totalRows} ì¤„, ì†ë„: {processingSpeed} ì¤„/ì´ˆ";
                //});
            });

            // ìµœì¢… ì²˜ë¦¬ ì‹œê°„ ê³„ì‚°
            var totalElapsedTime = DateTime.Now - startTime;


            // UI ìŠ¤ë ˆë“œì—ì„œ í”½ì…€ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì”€
            Application.Current.Dispatcher.Invoke(() =>
            {
                writeableBitmap.Lock();
                writeableBitmap.WritePixels(new Int32Rect(0, 0, width, height), pixelData, width * 4, 0);
                writeableBitmap.Unlock();

                ProcessTimeTextBlock.Text = $"ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ì²˜ë¦¬ ì‹œê°„: {totalElapsedTime.TotalSeconds:F2}ì´ˆ";
            });            
        }

        private async void CannyEdge_Click(object sender, RoutedEventArgs e)
        {
            if (ImageView.Source is WriteableBitmap writeableBitmap)
            {
                try
                {
                    // ì²˜ë¦¬ì¤‘ ë³´ì´ê¸°
                    LoadingPanel.Visibility = Visibility.Visible;

                    WriteableBitmap writeableBitmap1 = null;
                    int width = 0, height = 0;

                    // UI ìŠ¤ë ˆë“œì—ì„œ WriteableBitmap ìƒì„± ë° í¬ê¸° ê°€ì ¸ì˜¤ê¸°
                    Application.Current.Dispatcher.Invoke(() =>
                    {
                        writeableBitmap1= new WriteableBitmap(writeableBitmap);
                        width = writeableBitmap.PixelWidth;
                        height = writeableBitmap.PixelHeight;
                    });


                    if (writeableBitmap1 == null || width == 0 || height == 0)
                        throw new InvalidOperationException("WriteableBitmapì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

                    // ì‹œì‘ ì‹œê°„ ê¸°ë¡
                    var startTime = DateTime.Now;

                    await Task.Run(() => ApplyCannyEdgeDetection(writeableBitmap1, width, height, startTime));

                    // UI ìŠ¤ë ˆë“œì—ì„œ WriteableBitmap ì—…ë°ì´íŠ¸
                    Application.Current.Dispatcher.Invoke(() =>
                    {
                        writeableBitmap1.Freeze();
                        ImageView.Source = writeableBitmap1;
                    });
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"ìºë‹ˆ ì—£ì§€ ê²€ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}",
                        "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error);
                }
                finally
                {
                    // ì²˜ë¦¬ì¤‘ ìˆ¨ê¸°ê¸°
                    LoadingPanel.Visibility = Visibility.Collapsed;

                    // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë²„íŠ¼ ë¹„í™œì„±í™”
                    GrayScaleButton.IsEnabled = false;
                    // ìºë‹ˆì—£ì§€ ë²„íŠ¼ ë¹„í™œì„±í™”
                    CannyEdgeButton.IsEnabled = false;
                    // ìšœë¡œv5 ë²„íŠ¼ í™œì„±í™”
                    YoloV5Button.IsEnabled = true;
                }
            }
            else
            {
                MessageBox.Show("ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void ApplyCannyEdgeDetection(WriteableBitmap writeableBitmap, int width, int height, DateTime startTime)
        {
            var pixelData = new byte[width * height * 4];

            // UI ìŠ¤ë ˆë“œì—ì„œ í”½ì…€ ë°ì´í„°ë¥¼ ë³µì‚¬
            Application.Current.Dispatcher.Invoke(() =>
            {
                writeableBitmap.CopyPixels(pixelData, width * 4, 0);
            });

            // ê°„ë‹¨í•œ ìºë‹ˆ ì—£ì§€ ì•Œê³ ë¦¬ì¦˜ (Sobel Gradient + Thresholding)
            var gradientData = new byte[width * height];

            int[] gx = { -1, 0, 1, -2, 0, 2, -1, 0, 1 };
            int[] gy = { -1, -2, -1, 0, 0, 0, 1, 2, 1 };

            Parallel.For(1, height - 1, y =>
            {
                for (int x = 1; x < width - 1; x++)
                {
                    int pixelIndex = (y * width + x) * 4;
                    double gradX = 0;
                    double gradY = 0;

                    for (int ky = -1; ky <= 1; ky++)
                    {
                        for (int kx = -1; kx <= 1; kx++)
                        {
                            int neighborIndex = ((y + ky) * width + (x + kx)) * 4;
                            byte intensity = pixelData[neighborIndex];
                            gradX += intensity * gx[(ky + 1) * 3 + (kx + 1)];
                            gradY += intensity * gy[(ky + 1) * 3 + (kx + 1)];
                        }
                    }

                    double gradientMagnitude = Math.Sqrt(gradX * gradX + gradY * gradY);
                    gradientData[y * width + x] = (byte)(gradientMagnitude > 128 ? 255 : 0);
                }
            });


            Parallel.For(0, height, y =>
            {
                for (int x = 0; x < width; x++)
                {
                    int pixelIndex = (y * width + x) * 4;
                    byte edge = gradientData[y * width + x];
                    pixelData[pixelIndex] = edge;
                    pixelData[pixelIndex + 1] = edge;
                    pixelData[pixelIndex + 2] = edge;
                }
            });

            // ìµœì¢… ì²˜ë¦¬ ì‹œê°„ ê³„ì‚°
            var totalElapsedTime = DateTime.Now - startTime;

            // UI ìŠ¤ë ˆë“œì—ì„œ í”½ì…€ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì”€
            Application.Current.Dispatcher.Invoke(() =>
            {
                writeableBitmap.Lock();
                writeableBitmap.WritePixels(new Int32Rect(0, 0, width, height), pixelData, width * 4, 0);
                writeableBitmap.Unlock();

                ProcessTimeTextBlock.Text = $"ìºë‹ˆì—£ì§€ ì²˜ë¦¬ ì‹œê°„: {totalElapsedTime.TotalSeconds:F2}ì´ˆ";
            });
        }

        private async void YoloV5_Click(object sender, RoutedEventArgs e)
        {
            if (ImageView.Source is WriteableBitmap writeableBitmap)
            {
                try
                {
                    // ì²˜ë¦¬ì¤‘ ë³´ì´ê¸°
                    LoadingPanel.Visibility = Visibility.Visible;

                    WriteableBitmap writeableBitmap1 = null;
                    int width = 0, height = 0;

                    // UI ìŠ¤ë ˆë“œì—ì„œ WriteableBitmap ìƒì„± ë° í¬ê¸° ê°€ì ¸ì˜¤ê¸°
                    Application.Current.Dispatcher.Invoke(() =>
                    {
                        writeableBitmap1 = new WriteableBitmap(writeableBitmap);
                        width = writeableBitmap.PixelWidth;
                        height = writeableBitmap.PixelHeight;
                    });


                    if (writeableBitmap1 == null || width == 0 || height == 0)
                        throw new InvalidOperationException("WriteableBitmapì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

                    // ì‹œì‘ ì‹œê°„ ê¸°ë¡
                    var startTime = DateTime.Now;

                    await Task.Run(() => ProcessYoloV5Async(writeableBitmap1, width, height, startTime));

                    // UI ìŠ¤ë ˆë“œì—ì„œ WriteableBitmap ì—…ë°ì´íŠ¸
                    Application.Current.Dispatcher.Invoke(() =>
                    {
                        writeableBitmap1.Freeze();
                        ImageView.Source = writeableBitmap1;
                    });
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"ìšœë¡œv5ê²€ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}",
                        "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error);
                }
                finally
                {
                    // ì²˜ë¦¬ì¤‘ ìˆ¨ê¸°ê¸°
                    LoadingPanel.Visibility = Visibility.Collapsed;

                    // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë²„íŠ¼ ë¹„í™œì„±í™”
                    GrayScaleButton.IsEnabled = false;
                    // ìºë‹ˆì—£ì§€ ë²„íŠ¼ ë¹„í™œì„±í™”
                    CannyEdgeButton.IsEnabled = false;
                    // ìšœë¡œv5 ë²„íŠ¼ í™œì„±í™”
                    YoloV5Button.IsEnabled = false;
                }
            }
            else
            {
                MessageBox.Show("ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.", "ì˜¤ë¥˜", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void ProcessYoloV5Async(WriteableBitmap writeableBitmap, int width, int height, DateTime startTime)
        {
            var pythonScriptPath = @"C:\yolov5result\yolov5_inference.py";
            var inputImagePath = "yolov5_input_image.png";
            var outputImagePath = "yolov5_output_image.png";

            var pixelData = new byte[width * height * 4];

            // UI ìŠ¤ë ˆë“œì—ì„œ í”½ì…€ ë°ì´í„°ë¥¼ ë³µì‚¬
            Application.Current.Dispatcher.Invoke(() =>
            {
                writeableBitmap.CopyPixels(pixelData, width * 4, 0);
            });

            // í”½ì…€ë°ì´í„°ë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥
            SaveBitmapToPng(writeableBitmap, inputImagePath);

            // Yolov5 ê²€ì¶œ ë¡œì§
            var processStartInfo = new ProcessStartInfo
            {
                FileName = "python",
                Arguments = $"\"{pythonScriptPath}\" \"{inputImagePath}\" \"{outputImagePath}\"",
                CreateNoWindow = true,
                UseShellExecute = false
            };

            using (var process = Process.Start(processStartInfo))
            {
                process.WaitForExit(); // Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            }

            // ì¶œë ¥ ì´ë¯¸ì§€ í”½ì…€ ë°ì´í„°ë¡œ ë³€í™˜
            byte[] outputPixelData = LoadPngToPixels(outputImagePath, out width, out height);

            // ìµœì¢… ì²˜ë¦¬ ì‹œê°„ ê³„ì‚°
            var totalElapsedTime = DateTime.Now - startTime;

            // UI ìŠ¤ë ˆë“œì—ì„œ í”½ì…€ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì”€
            Application.Current.Dispatcher.Invoke(() =>
            {
                writeableBitmap.Lock();
                writeableBitmap.WritePixels(new Int32Rect(0, 0, width, height), outputPixelData, width * 4, 0);
                writeableBitmap.Unlock();

                ProcessTimeTextBlock.Text = $"ìšœë¡œv5ê°ì²´ê°ì§€ ì²˜ë¦¬ ì‹œê°„: {totalElapsedTime.TotalSeconds:F2}ì´ˆ";
            });
        }

        // ì´ë¯¸ì§€ íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
        private void SaveBitmapToPng(WriteableBitmap writeableBitmap, string filePath)
        {
            if (writeableBitmap == null)
                throw new ArgumentNullException(nameof(writeableBitmap), "WriteableBitmapì´ nullì…ë‹ˆë‹¤.");

            BitmapSource clonedBitmap = null;

            // UI ìŠ¤ë ˆë“œì—ì„œ Bitmapì„ ë³µì‚¬í•˜ê³  Freeze() í˜¸ì¶œ
            Application.Current.Dispatcher.Invoke(() =>
            {
                var renderTarget = new RenderTargetBitmap(
                    writeableBitmap.PixelWidth, writeableBitmap.PixelHeight,
                    96, 96, PixelFormats.Pbgra32);

                var visual = new DrawingVisual();
                using (var context = visual.RenderOpen())
                {
                    context.DrawImage(writeableBitmap, new Rect(0, 0, writeableBitmap.PixelWidth, writeableBitmap.PixelHeight));
                }
                renderTarget.Render(visual);

                clonedBitmap = renderTarget;
                clonedBitmap.Freeze(); // ë°˜ë“œì‹œ UI ìŠ¤ë ˆë“œì—ì„œ í˜¸ì¶œí•´ì•¼ ì˜¤ë¥˜ ì—†ìŒ
            });

            using (var stream = new FileStream(filePath, FileMode.Create))
            {
                var encoder = new PngBitmapEncoder();
                encoder.Frames.Add(BitmapFrame.Create(clonedBitmap));
                encoder.Save(stream);
            }
        }



        // ì´ë¯¸ì§€ íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ í”½ì…€ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
        private byte[] LoadPngToPixels(string filePath, out int width, out int height)
        {
            try
            {
                if (!File.Exists(filePath))
                {
                    MessageBox.Show($"íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {filePath}");
                    width = height = 0;
                    return null;
                }

                // PNG íŒŒì¼ì´ ì™„ì „íˆ ì €ì¥ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                WaitForFile(filePath);

                var bitmapImage = new BitmapImage();
                bitmapImage.BeginInit();
                bitmapImage.UriSource = new Uri(filePath, UriKind.Absolute);
                bitmapImage.CacheOption = BitmapCacheOption.OnLoad; // ì¦‰ì‹œ ë¡œë“œí•˜ì—¬ íŒŒì¼ ì ê¹€ ë°©ì§€
                bitmapImage.CreateOptions = BitmapCreateOptions.IgnoreImageCache; // ì´ë¯¸ì§€ ìºì‹œ ë¬´ì‹œ
                bitmapImage.EndInit();
                bitmapImage.Freeze(); // ìŠ¤ë ˆë“œ ì•ˆì „ ì²˜ë¦¬

                WriteableBitmap writeableBitmap = null;

                // UI ìŠ¤ë ˆë“œì—ì„œ WriteableBitmap ìƒì„±
                Application.Current.Dispatcher.Invoke(() =>
                {
                    writeableBitmap = new WriteableBitmap(bitmapImage);
                });

                width = writeableBitmap.PixelWidth;
                height = writeableBitmap.PixelHeight;

                var pixels = new byte[width * height * 4];

                // í”½ì…€ ë°ì´í„° ì¶”ì¶œ
                writeableBitmap.CopyPixels(pixels, width * 4, 0);

                return pixels;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"PNG ë¡œë“œ ì‹¤íŒ¨: {ex.Message}");
                width = height = 0;
                return null;
            }
        }

        // íŒŒì¼ì´ ì™„ì „íˆ ì €ì¥ë  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ëŠ” í•¨ìˆ˜
        private void WaitForFile(string filePath)
        {
            int retryCount = 0;
            while (retryCount < 5)
            {
                try
                {
                    using (var stream = new FileStream(filePath, FileMode.Open, FileAccess.Read, FileShare.None))
                    {
                        return; // íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ì—´ë©´ ì¢…ë£Œ
                    }
                }
                catch (IOException)
                {
                    Thread.Sleep(200); // 200ms ëŒ€ê¸° í›„ ì¬ì‹œë„
                    retryCount++;
                }
            }
        }

    }
}

cuda version
c:\>nvidia-smi
Thu Jan 30 20:05:58 2025
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 566.14                 Driver Version: 566.14         CUDA Version: 12.7     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                  Driver-Model | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  NVIDIA GeForce RTX 4060 ...  WDDM  |   00000000:01:00.0 Off |                  N/A |
| N/A   45C    P8              2W /   85W |       1MiB /   8188MiB |      0%      Default |
|                                         |                        |                  N/A |
+-----------------------------------------+------------------------+----------------------+

+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |
|        ID   ID                                                               Usage      |
|=========================================================================================|
|  No running processes found                                                             |
+-----------------------------------------------------------------------------------------+

NVIDIA ë“œë¼ì´ë²„ ë²„ì „	566.14
CUDA ë²„ì „	12.7
GPU ëª¨ë¸	NVIDIA GeForce RTX 4060
GPU ë©”ëª¨ë¦¬	8GB (8188MiB)

torch ë²„ì „
c:\>python -c "import torch; print(torch.__version__)"
2.6.0+cpu
=> GPU ì§€ì› ë²„ì „ì˜ PyTorch ì„¤ì¹˜
c:\>pip uninstall torch
c:\>pip install torch==2.6.0+cu118 --extra-index-url https://download.pytorch.org/whl/cu118
c:\>python -c "import torch; print(torch.__version__); print(torch.cuda.is_available()); print(torch.cuda.current_device()); print(torch.cuda.get_device_name(torch.cuda.current_device()))"
2.6.0+cu118
True
0
NVIDIA GeForce RTX 4060 Laptop GPU

ultralytics ë²„ì „
c:\>python -c "import ultralytics; print(ultralytics.__version__)"
8.3.69

c:\>python --version
Python 3.13.0

yolov5ì„¤ì¹˜ ë° ì—…ê·¸ë ˆì´ë“œ
c:\>git clone https://github.com/ultralytics/yolov5.git
c:\>cd yolov5
c:\yolov5>pip install -U -r requirements.txt
c:\yolov5>python.exe -m pip install --upgrade pip
c:\yolov5>pip install --upgrade ultralytics
c:\yolov5>pip install --upgrade torch

í…ŒìŠ¤íŠ¸
C:\wpfProject\WpfApp2\WpfApp2\bin\Debug\net8.0-windows>python "C:\yolov5result\yolov5_inference.py" --source "C:\yolov5\yolov5_input_image.png" --output "C:\yolov5\yolov5_output_image.png"    

ì˜¤ë¥˜
C:\wpfProject\WpfApp2\WpfApp2\bin\Debug\net8.0-windows>python "C:\yolov5result\yolov5_inference.py" --source "C:\yolov5\yolov5_input_image.png" --output "C:\yolov5\yolov5_output_image.png"
Traceback (most recent call last):
  File "C:\yolov5result\yolov5_inference.py", line 24, in <module>
    run_inference(args.source, args.output)
    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\yolov5result\yolov5_inference.py", line 10, in run_inference
    results = model.predict(source)  # predictë¡œ ë³€ê²½, verbose ì¸ì ì œê±°
  File "C:\Users\nayou\AppData\Local\Programs\Python\Python313\Lib\site-packages\ultralytics\engine\model.py", line 551, in predict
    self.predictor.setup_model(model=self.model, verbose=is_cli)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\nayou\AppData\Local\Programs\Python\Python313\Lib\site-packages\ultralytics\engine\predictor.py", line 310, in setup_model
    self.model = AutoBackend(
                 ~~~~~~~~~~~^
        weights=model or self.args.model,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
        verbose=verbose,
        ^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\nayou\AppData\Local\Programs\Python\Python313\Lib\site-packages\torch\utils\_contextlib.py", line 116, in decorate_context
    return func(*args, **kwargs)
  File "C:\Users\nayou\AppData\Local\Programs\Python\Python313\Lib\site-packages\ultralytics\nn\autobackend.py", line 152, in __init__
    model = model.fuse(verbose=verbose)
TypeError: BaseModel.fuse() got an unexpected keyword argument 'verbose'

=> PyTorch ë° ultralyticsì™€ ê°™ì€ ë”¥ëŸ¬ë‹ ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ì€ Python 3.8 ë˜ëŠ” Python 3.9 python 3.9ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜í•˜ëŠ” ê²ƒì´ ì•ˆì •ì 
python 3.13.0 ì œì–´íŒ > í”„ë¡œê·¸ë¦¼ ë° ê¸°ëŠ¥ > ì œê±°
python 3.9 ë‹¤ìš´ë¡œë“œ í›„ ì„¤ì¹˜(https://www.python.org/downloads/release/python-390/)
Windows x86 executable installer	Windows     python-3.9.0.exe

ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ì‹œìŠ¤í…œí™˜ê²½ë³€ìˆ˜í¸ì§‘ > ê³ ê¸‰ > í™˜ê²½ë³€ìˆ˜ > ì‹œìŠ¤í…œ ë³€ìˆ˜ > 
PYTHONPATH : C:\Users\nayou\AppData\Local\Programs\Python\Python39-32;C:\Users\nayou\AppData\Local\Programs\Python\Python39-32\Scripts
Path : %PYTHONPATH%;...

íŒŒì´ì¬ ë²„ì „ í™•ì¸
c:\>python --version
Python 3.9.0

ìšœë¡œì„¤ì¹˜
c:\yolov5>pip install -r requrements.txt

pip ìµœì‹  ë²„ì „ ì„¤ì¹˜
c:\yolov5>c:\users\nayou\appdata\local\programs\python\python39-32\python.exe -m pip install --upgrade pip
Collecting pip

numpy ì„¤ì¹˜
c:\>pip install numpy
c:\>pip install numpy
Requirement already satisfied: numpy in c:\users\nayou\appdata\local\programs\python\python39-32\lib\site-packages (2.0.2)

scipy ì„¤ì¹˜
c:\>pip install scipy

c:\>where python
c:\msys64\mingw64\bin\python.exe
C:\Users\nayou\AppData\Local\Microsoft\WindowsApps\python.exe

ë‘ ìœ„ì¹˜ì— ê¸°ì¡´ python.exeë¥¼ ì œê±°í•˜ê³ 
C:\Users\nayou\AppData\Local\Programs\Python\Python39
python.exe
python39.dll
ì„ ë³µì‚¬í•´ì„œ ë„£ëŠ”ë‹¤

c:\>python --version
Python 3.9.0

c:\>py --version
Python 3.9.0

c:\>pip install scipy
'pip'ì€(ëŠ”) ë‚´ë¶€ ë˜ëŠ” ì™¸ë¶€ ëª…ë ¹, ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” í”„ë¡œê·¸ë¨, ë˜ëŠ”
ë°°ì¹˜ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.

c:\>python -m pip --version
pip 25.0 from C:\Users\nayou\AppData\Local\Programs\Python\Python39-32\lib\site-packages\pip (python 3.9)

c:\>python -m pip install scipy
ì˜¤ë¥˜ë¥˜
Collecting scipy
  Using cached scipy-1.13.1.tar.gz (57.2 MB)
  Installing build dependencies ... done
  Getting requirements to build wheel ... done
  Preparing metadata (pyproject.toml) ... error
  error: subprocess-exited-with-error

  Ã— Preparing metadata (pyproject.toml) did not run successfully.
  â”‚ exit code: 1
  â•°â”€> [31 lines of output]
      + meson setup C:\Users\nayou\AppData\Local\Temp\pip-install-h381g5d2\scipy_4b19255a0132492a9dba12edbe3d1c02 C:\Users\nayou\AppData\Local\Temp\pip-install-h381g5d2\scipy_4b19255a0132492a9dba12edbe3d1c02\.mesonpy-38w5kk43 -Dbuildtype=release -Db_ndebug=if-release -Db_vscrt=md --native-file=C:\Users\nayou\AppData\Local\Temp\pip-install-h381g5d2\scipy_4b19255a0132492a9dba12edbe3d1c02\.mesonpy-38w5kk43\meson-python-native-file.ini
      The Meson build system
      Version: 1.7.0
      Source dir: C:\Users\nayou\AppData\Local\Temp\pip-install-h381g5d2\scipy_4b19255a0132492a9dba12edbe3d1c02
      Build dir: C:\Users\nayou\AppData\Local\Temp\pip-install-h381g5d2\scipy_4b19255a0132492a9dba12edbe3d1c02\.mesonpy-38w5kk43
      Build type: native build
      Project name: scipy
      Project version: 1.13.1
      C compiler for the host machine: cl (msvc 19.29.30158 "x86ìš© Microsoft (R) C/C++ ìµœì í™” ì»´íŒŒì¼ëŸ¬ ë²„ì „ 19.29.30158")
      C linker for the host machine: link link 14.29.30158.0
      C++ compiler for the host machine: cl (msvc 19.29.30158 "x86ìš© Microsoft (R) C/C++ ìµœì í™” ì»´íŒŒì¼ëŸ¬ ë²„ì „ 19.29.30158")
      C++ linker for the host machine: link link 14.29.30158.0
      Cython compiler for the host machine: cython (cython 3.0.11)
      Host machine cpu family: x86
      Host machine cpu: x86
      Program python found: YES (c:\msys64\mingw64\bin\python.exe)
      Run-time dependency python found: YES 3.9
      Program cython found: YES (C:\Users\nayou\AppData\Local\Temp\pip-build-env-7psmfzwm\overlay\Scripts\cython.EXE)
      Compiler for C supports arguments -Wno-unused-but-set-variable: NO
      Compiler for C supports arguments -Wno-unused-function: NO
      Compiler for C supports arguments -Wno-conversion: NO
      Compiler for C supports arguments -Wno-misleading-indentation: NO
      Library m found: NO

      ..\meson.build:78:0: ERROR: Unable to detect linker for compiler `gfortran -Wl,--version`
      stdout:
      stderr: gfortran: fatal error: '-fuse-linker-plugin', but liblto_plugin.dll not found
      compilation terminated.


      A full log can be found at C:\Users\nayou\AppData\Local\Temp\pip-install-h381g5d2\scipy_4b19255a0132492a9dba12edbe3d1c02\.mesonpy-38w5kk43\meson-logs\meson-log.txt
      [end of output]

  note: This error originates from a subprocess, and is likely not a problem with pip.
error: metadata-generation-failed

Ã— Encountered error while generating package metadata.
â•°â”€> See above for output.

note: This is an issue with the package mentioned above, not pip.
hint: See above for details.

ìˆ˜ì •
gfortran ì»´íŒŒì¼ëŸ¬ì™€ ê´€ë ¨ëœ liblto_plugin.dll íŒŒì¼ì´ ëˆ„ë½

MSYS2ì—ì„œ ì‘ì—…
íŒ¨í‚¤ì§€ ëª©ë¡ ìµœì‹ ìœ¼ë¡œ ì—…ë°ì´íŠ¸
nayou@nayoungkim MINGW64 ~
# pacman -Syu

íŒ¨í‚¤ì§€ ì´ë¦„ í™•ì¸
nayou@nayoungkim MINGW64 ~
# pacman -Ss gfortran
mingw32/mingw-w64-i686-gcc-libgfortran 14.2.0-2
    GNU Compiler Collection (libgfortran) for MinGW-w64
mingw64/mingw-w64-x86_64-gcc-libgfortran 14.2.0-2
    GNU Compiler Collection (libgfortran) for MinGW-w64
ucrt64/mingw-w64-ucrt-x86_64-gcc-libgfortran 14.2.0-2
    GNU Compiler Collection (libgfortran) for MinGW-w64

Fortran ì»´íŒŒì¼ëŸ¬ ì„¤ì¹˜
nayou@nayoungkim MINGW64 ~
# pacman -S mingw-w64-x86_64-gcc-libgfortran
ì˜ì¡´ì„± í•´ê²° ì¤‘...
ê¾¸ëŸ¬ë¯¸ ì¶©ëŒì„ ì°¾ëŠ” ì¤‘...

ê¾¸ëŸ¬ë¯¸ (1) mingw-w64-x86_64-gcc-libgfortran-14.2.0-2

ì´ ë‹¤ìš´ë¡œë“œ í¬ê¸°:  0.89 MiB
ì´ ì„¤ì¹˜ í¬ê¸°:      3.27 MiB

:: ì„¤ì¹˜ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? [Y/n] y
:: ê¾¸ëŸ¬ë¯¸ ê°€ì ¸ì˜¤ëŠ” ì¤‘...
 mingw-w64-x86_64-gcc-l...   910.3 KiB   193 KiB/s 00:05 [#############################] 100%
(1/1) í‚¤ë§ì˜ í‚¤ë¥¼ ê²€ì‚¬ ì¤‘                                [#############################] 100%
(1/1) ê¾¸ëŸ¬ë¯¸ ë¬´ê²°ì„± ê²€ì‚¬ ì¤‘                              [#############################] 100%
(1/1) ê¾¸ëŸ¬ë¯¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘                            [#############################] 100%
(1/1) íŒŒì¼ ì¶©ëŒ ê²€ì‚¬ ì¤‘                                  [#############################] 100%
ì˜¤ë¥˜: ì»¤ë°‹ íŠ¸ëœì­ì…˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤(íŒŒì¼ì´ ì¶©ëŒí•©ë‹ˆë‹¤.)
mingw-w64-x86_64-gcc-libgfortran: /mingw64/bin/libgfortran-5.dllê°€ íŒŒì¼ ì‹œìŠ¤í…œì— ìˆìŠµë‹ˆë‹¤
ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ì—…ê·¸ë ˆì´ë“œí•œ ê¾¸ëŸ¬ë¯¸ê°€ ì—†ìŠµë‹ˆë‹¤.
nayou@nayoungkim MINGW64 ~
# rm /mingw64/bin/libgfortran-5.dll
pacman -S mingw-w64-x86_64-gcc-libgfortran
ì˜ì¡´ì„± í•´ê²° ì¤‘...
ê¾¸ëŸ¬ë¯¸ ì¶©ëŒì„ ì°¾ëŠ” ì¤‘...

ê¾¸ëŸ¬ë¯¸ (1) mingw-w64-x86_64-gcc-libgfortran-14.2.0-2

ì´ ì„¤ì¹˜ í¬ê¸°:  3.27 MiB

:: ì„¤ì¹˜ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? [Y/n] y
(1/1) í‚¤ë§ì˜ í‚¤ë¥¼ ê²€ì‚¬ ì¤‘                                [#############################] 100%
(1/1) ê¾¸ëŸ¬ë¯¸ ë¬´ê²°ì„± ê²€ì‚¬ ì¤‘                              [#############################] 100%
(1/1) ê¾¸ëŸ¬ë¯¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘                            [#############################] 100%
(1/1) íŒŒì¼ ì¶©ëŒ ê²€ì‚¬ ì¤‘                                  [#############################] 100%
(1/1) ì‚¬ìš© ê°€ëŠ¥í•œ ë””ìŠ¤í¬ ê³µê°„ ê²€ì‚¬ ì¤‘                    [#############################] 100%
:: ê¾¸ëŸ¬ë¯¸ ë³€ê²½ì‚¬í•­ì„ ì²˜ë¦¬ ì¤‘...
(1/1) ì„¤ì¹˜ ì¤‘ mingw-w64-x86_64-gcc-libgfortran           [#############################] 100%

nayou@nayoungkim MINGW64 ~
# gfortran --version
GNU Fortran (x86_64-win32-seh-rev0, Built by MinGW-Builds project) 14.2.0
Copyright (C) 2024 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

nayou@nayoungkim MINGW64 ~
# pip install scipy
ì˜¤ë¥˜
Collecting scipy
  Using cached scipy-1.13.1.tar.gz (57.2 MB)
  Installing build dependencies ... done
  Getting requirements to build wheel ... done
  Preparing metadata (pyproject.toml) ... error
  error: subprocess-exited-with-error

  Ã— Preparing metadata (pyproject.toml) did not run successfully.
  â”‚ exit code: 1
  â•°â”€> [22 lines of output]
      + meson setup C:\msys64\tmp\pip-install-taq9vg20\scipy_0f9ec79c595949dcbf209065dc45be01 C:\msys64\tmp\pip-install-taq9vg20\scipy_0f9ec79c595949dcbf209065dc45be01\.mesonpy-l43zklre -Dbuildtype=release -Db_ndebug=if-release -Db_vscrt=md --native-file=C:\msys64\tmp\pip-install-taq9vg20\scipy_0f9ec79c595949dcbf209065dc45be01\.mesonpy-l43zklre\meson-python-native-file.ini
      The Meson build system
      Version: 1.7.0
      Source dir: C:\msys64\tmp\pip-install-taq9vg20\scipy_0f9ec79c595949dcbf209065dc45be01
      Build dir: C:\msys64\tmp\pip-install-taq9vg20\scipy_0f9ec79c595949dcbf209065dc45be01\.mesonpy-l43zklre
      Build type: native build
      Project name: scipy
      Project version: 1.13.1
      C compiler for the host machine: x86_64-w64-mingw32-gcc (gcc 14.2.0 "x86_64-w64-mingw32-gcc (Rev2, Built by MSYS2 project) 14.2.0")
      C linker for the host machine: x86_64-w64-mingw32-gcc ld.bfd 2.43.1
      C++ compiler for the host machine: x86_64-w64-mingw32-g++ (gcc 14.2.0 "x86_64-w64-mingw32-g++ (Rev2, Built by MSYS2 project) 14.2.0")
      C++ linker for the host machine: x86_64-w64-mingw32-g++ ld.bfd 2.43.1
      Cython compiler for the host machine: cython (cython 3.0.11)
      Host machine cpu family: x86_64
      Host machine cpu: x86_64
      Program python found: YES (c:\users\nayou\appdata\local\programs\python\python39-32\python.exe)
      Need python for x86_64, but found x86
      Run-time dependency python found: NO (tried sysconfig)

      ..\meson.build:22:14: ERROR: Python dependency not found

      A full log can be found at C:\msys64\tmp\pip-install-taq9vg20\scipy_0f9ec79c595949dcbf209065dc45be01\.mesonpy-l43zklre\meson-logs\meson-log.txt
      [end of output]

  note: This error originates from a subprocess, and is likely not a problem with pip.
error: metadata-generation-failed

Ã— Encountered error while generating package metadata.
â•°â”€> See above for output.

note: This is an issue with the package mentioned above, not pip.
hint: See above for details.
ìˆ˜ì •

Python 3.9 32bit -> 64bitë¡œ ì¬ì„¤ì¹˜
Python 3.9.5 Windows Installer 64bit ì„¤ì¹˜
https://www.python.org/downloads/release/python-395/
Windows installer (64-bit)	Windows	Recommended	53a354a15baed952ea9519a7f4d87c3f	27.1 MB	SIG
í™˜ê²½ë³€ìˆ˜, where ê²½ë¡œë“±ì„ ë³€ê²½í•˜ì—¬ ì¤€ë‹¤

nayou@nayoungkim MINGW64 ~
# pip install scipy
Collecting scipy
  Downloading scipy-1.13.1-cp39-cp39-win_amd64.whl (46.2 MB)
     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 46.2 MB 6.4 MB/s
Collecting numpy<2.3,>=1.22.4
  Downloading numpy-2.0.2-cp39-cp39-win_amd64.whl (15.9 MB)
     |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 15.9 MB 6.8 MB/s
Installing collected packages: numpy, scipy
Successfully installed numpy-2.0.2 scipy-1.13.1
WARNING: You are using pip version 21.1.1; however, version 25.0 is available.
You should consider upgrading via the 'c:\users\nayou\appdata\local\programs\python\python39\python.exe -m pip install --upgrade pip' command.

nayou@nayoungkim MINGW64 ~
# python  -m pip install --upgrade pip
Requirement already satisfied: pip in c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages (21.1.1)
Collecting pip
  Using cached pip-25.0-py3-none-any.whl (1.8 MB)
Installing collected packages: pip
  Attempting uninstall: pip
    Found existing installation: pip 21.1.1
    Uninstalling pip-21.1.1:
      Successfully uninstalled pip-21.1.1
Successfully installed pip-25.0

nayou@nayoungkim MINGW64 ~
# pip install scipy
Requirement already satisfied: scipy in c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages (1.13.1)
Requirement already satisfied: numpy<2.3,>=1.22.4 in c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages (from scipy) (2.0.2)

nayou@nayoungkim MINGW64 ~
# pip uninstall scipy
Found existing installation: scipy 1.13.1
Uninstalling scipy-1.13.1:
  Would remove:
    c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages\scipy-1.13.1-cp39-cp39-win_amd64.whl
    c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages\scipy-1.13.1.dist-info\*
    c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages\scipy.libs\.load-order-scipy-1.13.1
    c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages\scipy.libs\libopenblas_v0.3.27--3aa239bc726cfb0bd8e5330d8d4c15c6.dll
    c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages\scipy\*
Proceed (Y/n)? y
  Successfully uninstalled scipy-1.13.1

nayou@nayoungkim MINGW64 ~
# pip install scipy
Collecting scipy
  Downloading scipy-1.13.1-cp39-cp39-win_amd64.whl.metadata (60 kB)
Requirement already satisfied: numpy<2.3,>=1.22.4 in c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages (from scipy) (2.0.2)
Downloading scipy-1.13.1-cp39-cp39-win_amd64.whl (46.2 MB)
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 46.2/46.2 MB 9.9 MB/s eta 0:00:00
Installing collected packages: scipy
Successfully installed scipy-1.13.1

ë‹¤ì‹œ yolov5 ì„¤ì •
c:\>cd yolov5
c:\yolov5>pip install -U -r requirements.txt
c:\yolov5>python.exe -m pip install --upgrade pip
c:\yolov5>pip install --upgrade ultralytics
c:\yolov5>pip install --upgrade torch

í…ŒìŠ¤íŠ¸
C:\wpfProject\WpfApp2\WpfApp2\bin\Debug\net8.0-windows>python "C:\yolov5result\yolov5_inference.py" --source "C:\yolov5\yolov5_input_image.png" --output "C:\yolov5\yolov5_output_image.png" 

C:\wpfProject\WpfApp2\WpfApp2\bin\Debug\net8.0-windows>python "C:\yolov5result\yolov5_inference.py" --source "C:\yolov5\yolov5_input_image.png" --output "C:\yolov5\yolov5_output_image.png"
WARNING âš ï¸ C:\yolov5result\exp23\weights\best.pt appears to require 'dill', which is not in Ultralytics requirements.
AutoInstall will run now for 'dill' but this feature will be removed in the future.
Recommend fixes are to train a new model using the latest 'ultralytics' package or to run a command with an official Ultralytics model, i.e. 'yolo predict model=yolo11n.pt'
requirements: Ultralytics requirement ['dill'] not found, attempting AutoUpdate...
Collecting dill
  Downloading dill-0.3.9-py3-none-any.whl.metadata (10 kB)
Downloading dill-0.3.9-py3-none-any.whl (119 kB)
Installing collected packages: dill
Successfully installed dill-0.3.9

requirements: AutoUpdate success âœ… 0.8s, installed 1 package: ['dill']
requirements: âš ï¸ Restart runtime or rerun command for updates to take effect

Traceback (most recent call last):
  File "C:\yolov5result\yolov5_inference.py", line 24, in <module>
    run_inference(args.source, args.output)
  File "C:\yolov5result\yolov5_inference.py", line 10, in run_inference
    results = model.predict(source)  # predictë¡œ ë³€ê²½, verbose ì¸ì ì œê±°
  File "C:\Users\nayou\AppData\Local\Programs\Python\Python39\lib\site-packages\ultralytics\engine\model.py", line 551, in predict
    self.predictor.setup_model(model=self.model, verbose=is_cli)
  File "C:\Users\nayou\AppData\Local\Programs\Python\Python39\lib\site-packages\ultralytics\engine\predictor.py", line 310, in setup_model
    self.model = AutoBackend(
  File "C:\Users\nayou\AppData\Local\Programs\Python\Python39\lib\site-packages\torch\utils\_contextlib.py", line 116, in decorate_context
    return func(*args, **kwargs)
  File "C:\Users\nayou\AppData\Local\Programs\Python\Python39\lib\site-packages\ultralytics\nn\autobackend.py", line 152, in __init__
    model = model.fuse(verbose=verbose)
TypeError: fuse() got an unexpected keyword argument 'verbose'

MSYS2
pip uninstall ultralytics
pip uninstall torch
pip install ultralytics==8.0.40  # ultralyticsì˜ íŠ¹ì • ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜ 
pip install torch==1.13.1  # í˜¸í™˜ë˜ëŠ” torch ë²„ì „ìœ¼ë¡œ ì„¤ì¹˜

ultralytics --version 
ImportError: DLL load failed while importing cv2: ì§€ì •ëœ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

nayou@nayoungkim MINGW64 ~
# pip uninstall opencv-python
pip install opencv-python
Found existing installation: opencv-python 4.11.0.86
Uninstalling opencv-python-4.11.0.86:
  Would remove:
    c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages\cv2\*
    c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages\opencv_python-4.11.0.86.dist-info\*
Proceed (Y/n)? y
  Successfully uninstalled opencv-python-4.11.0.86
Collecting opencv-python
  Using cached opencv_python-4.11.0.86-cp37-abi3-win_amd64.whl.metadata (20 kB)
Requirement already satisfied: numpy>=1.17.0 in c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages (from opencv-python) (2.0.2)
Using cached opencv_python-4.11.0.86-cp37-abi3-win_amd64.whl (39.5 MB)
Installing collected packages: opencv-python
Successfully installed opencv-python-4.11.0.86

nayou@nayoungkim MINGW64 ~
# ultralytics --version
ImportError: DLL load failed while importing cv2: ì§€ì •ëœ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

nayou@nayoungkim MINGW64 ~
# pip install opencv-python
Collecting opencv-python
  Using cached opencv_python-4.11.0.86-cp37-abi3-win_amd64.whl.metadata (20 kB)
Requirement already satisfied: numpy>=1.17.0 in c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages (from opencv-python) (2.0.2)
Using cached opencv_python-4.11.0.86-cp37-abi3-win_amd64.whl (39.5 MB)
Installing collected packages: opencv-python
Successfully installed opencv-python-4.11.0.86

nayou@nayoungkim MINGW64 ~
# pip install opencv-contrib-python
Collecting opencv-contrib-python
  Downloading opencv_contrib_python-4.11.0.86-cp37-abi3-win_amd64.whl.metadata (20 kB)
Requirement already satisfied: numpy>=1.17.0 in c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages (from opencv-contrib-python) (2.0.2)
Downloading opencv_contrib_python-4.11.0.86-cp37-abi3-win_amd64.whl (46.2 MB)
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 46.2/46.2 MB 9.5 MB/s eta 0:00:00
Installing collected packages: opencv-contrib-python
Successfully installed opencv-contrib-python-4.11.0.86

nayou@nayoungkim MINGW64 ~
# python -c "import cv2; print(cv2.__version__)"
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "C:\Users\nayou\AppData\Local\Programs\Python\Python39\lib\site-packages\cv2\__init__.py", line 181, in <module>
    bootstrap()
  File "C:\Users\nayou\AppData\Local\Programs\Python\Python39\lib\site-packages\cv2\__init__.py", line 153, in bootstrap
    native_module = importlib.import_module("cv2")
  File "C:\Users\nayou\AppData\Local\Programs\Python\Python39\Lib\importlib\__init__.py", line 127, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
ImportError: DLL load failed while importing cv2: ì§€ì •ëœ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

OpenCVëŠ” Microsoft Visual C++ Redistributableì— ì˜ì¡´
https://learn.microsoft.com/en-us/cpp/windows/latest-supported-vc-redist?view=msvc-170
ì„¤ì • > ì‹œìŠ¤í…œ > ì •ë³´ > 64ë¹„íŠ¸ ìš´ì˜ ì²´ì œ, x64 ê¸°ë°˜ í”„ë¡œì„¸ì„œ
X64	https://aka.ms/vs/17/release/vc_redist.x64.exe ë‹¤ìš´ë¡œë“œ í›„ ì„¤ì¹˜

í™˜ê²½ë³€ìˆ˜ì„¤ì •
CV2 : C:\Users\nayou\AppData\Local\Programs\Python\Python39\Lib\site-packages\cv2
Path : %CV2%;...

cv2í…ŒìŠ¤íŠ¸
nayou@nayoungkim MINGW64 ~
$ python -c "import sys; print(sys.executable)"
C:\msys64\mingw64\bin\python.exe

nayou@nayoungkim MINGW64 ~
$ python -c "import cv2; print(cv2.__version__)"
ImportError: DLL load failed while importing cv2: ì§€ì •ëœ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

nayou@nayoungkim MINGW64 ~
$ /c/Users/nayou/AppData/Local/Programs/Python/Python39/python.exe -c "import cv2; print(cv2.__version__)"
4.11.0

nayou@nayoungkim MINGW64 ~
$ which python
/mingw64/bin/python

~/.bashrc í™˜ê²½ë³€ìˆ˜ PATH ìˆœì„œë³€ê²½
export PATH="/c/Users/nayou/AppData/Local/Programs/Python/Python39"  # Python ë””ë ‰í† ë¦¬ ì¶”ê°€
export PATH="$PATH:/c/Users/nayou/AppData/Local/Programs/Python/Python39/Scripts"  # Python ë””ë ‰í† ë¦¬ ì¶”ê°€
export PATH="$PATH:/mingw64/bin"

nayou@nayoungkim MINGW64 ~
$ which python
/c/Users/nayou/AppData/Local/Programs/Python/Python39/python

nayou@nayoungkim MINGW64 ~
$  python -c "import cv2; print(cv2.__version__)"
4.11.0

C:\>python -c "import cv2; print(cv2.__version__)"
4.11.0

ë‹¤ì‹œ ultralytics ë²„ì „ í™•ì¸
nayou@nayoungkim MINGW64 ~
$ ultralytics --version
ImportError: DLL load failed while importing cv2: ì§€ì •ëœ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ultralyticsê°€ ì œëŒ€ë¡œ ì„¤ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
nayou@nayoungkim MINGW64 ~
$ pip list | grep ultralytics
ultralytics             8.0.40
ultralytics-thop        2.0.14

nayou@nayoungkim MINGW64 ~
$ which ultralytics
/c/Users/nayou/AppData/Local/Programs/Python/Python39/Scripts/ultralytics

nayou@nayoungkim MINGW64 ~
$ pip show ultralytics
Name: ultralytics
Version: 8.3.70
Summary: Ultralytics YOLO ğŸš€ for SOTA object detection, multi-object tracking, instance segmentation, pose estimation and image classification.
Home-page: https://ultralytics.com
Author:
Author-email: Glenn Jocher <glenn.jocher@ultralytics.com>, Jing Qiu <jing.qiu@ultralytics.com>
License: AGPL-3.0
Location: c:\users\nayou\appdata\local\programs\python\python39\lib\site-packages
Requires: matplotlib, numpy, opencv-python, pandas, pillow, psutil, py-cpuinfo, pyyaml, requests, scipy, seaborn, torch, torchvision, tqdm, ultralytics-thop
Required-by:

nayou@nayoungkim MINGW64 ~
$  python -c "import ultralytics; print(dir(ultralytics))"
['ASSETS', 'FastSAM', 'NAS', 'RTDETR', 'SAM', 'SETTINGS', 'YOLO', 'YOLOWorld', '__all__', '__builtins__', '__cached__', '__doc__', '__file__', '__loader__', '__name__', '__package__', '__path__', '__spec__', '__version__', 'cfg', 'checks', 'data', 'download', 'engine', 'hub', 'models', 'nn', 'os', 'settings', 'utils']

nayou@nayoungkim MINGW64 ~
$ python -m ultralytics.YOLO --version
C:\Users\nayou\AppData\Local\Programs\Python\Python39\python.exe: No module named ultralytics.YOLO

nayou@nayoungkim MINGW64 ~
$  python -c "from ultralytics import YOLO; model=YOLO('yolov5n.pt'); print(model)"
PRO TIP ğŸ’¡ Replace 'model=yolov5n.pt' with new 'model=yolov5nu.pt'.
YOLOv5 'u' models are trained with https://github.com/ultralytics/ultralytics and feature improved performance vs standard YOLOv5 models trained with https://github.com/ultralytics/yolov5.

Downloading https://github.com/ultralytics/assets/releases/download/v8.3.0/yolov5nu.pt to 'yolov5nu.pt'...
100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5.31M/5.31M [00:00<00:00, 10.5MB/s]
YOLO(
  (model): DetectionModel(
    (model): Sequential(
      (0): Conv(
        (conv): Conv2d(3, 16, kernel_size=(6, 6), stride=(2, 2), padding=(2, 2), bias=False)
        (bn): BatchNorm2d(16, eps=0.001, momentum=0.03, affine=True, track_running_stats=True)
        (act): SiLU(inplace=True)
      )
      (1): Conv(
        (conv): Conv2d(16, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
        (bn): BatchNorm2d(32, eps=0.001, momentum=0.03, affine=True, track_running_stats=True)
        (act): SiLU(inplace=True)
      )
...
=> YOLO ëª¨ë¸ì´ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìœ¼ë©°, ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œëœ í›„ ëª¨ë¸ êµ¬ì¡° ì •ë³´ê°€ ì¶œë ¥ë¨ 

c:\yolov5>git describe --tags
v7.0-398-g5cdad892

v7.0: YOLOv5ì˜ ë²„ì „ì´ v7.0
398: v7.0 íƒœê·¸ ì´í›„ì— 398ê°œì˜ ì»¤ë°‹ì´ ë” ì§„í–‰ë˜ì—ˆë‹¤
g5cdad892: ë§ˆì§€ë§‰ ì»¤ë°‹ì˜ í•´ì‹œ ê°’ì˜ ì¼ë¶€

í…ŒìŠ¤íŠ¸
python "C:\yolov5result\yolov5_inference.py" --source "yolov5_input_image.png" --output "yolov5_output_image.png"
